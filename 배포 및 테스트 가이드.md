# Queue-Based Load Leveling 프로젝트 배포 및 테스트 가이드

## 📋 개요

이 문서는 GitHub에서 클론한 Queue-Based Load Leveling 프로젝트(`https://github.com/xotlr333/queue-based-load-leveling`)를 macOS 환경의 Minikube에 배포하고, 부하 테스트를 수행하는 실무 가이드입니다.

## 🎯 최종 목표

- ✅ GitHub 프로젝트를 Minikube에 완전 배포
- ✅ RabbitMQ 기반 메시지 큐 시스템 구동
- ✅ Producer/Consumer 아키텍처 실행
- ✅ 모니터링 스위치 기능 테스트
- ✅ 대용량 부하 테스트 수행 및 패턴 효과 검증

## 🛠️ 1단계: 환경 준비

### 필수 도구 설치

```bash
# Homebrew로 필수 도구 설치
brew install --cask docker          # Docker Desktop
brew install minikube kubectl helm watch

# Python 환경 설정
python3 -m venv queue-pattern-env
source queue-pattern-env/bin/activate
```

### 프로젝트 클론

```bash
# GitHub에서 프로젝트 클론
git clone https://github.com/xotlr333/queue-based-load-leveling.git
cd queue-based-load-leveling

# 프로젝트 구조 확인
ls -la
cat README.md
```

### Python 의존성 설치

```bash
# 프로젝트 의존성 설치
pip install -r requirements.txt

# 부하 테스트용 추가 패키지 설치
pip install aiohttp psutil
```

## 🚀 2단계: Minikube 클러스터 구성

### Minikube 시작

```bash
# Minikube 시작 (macOS 최적화 설정)
minikube start \
  --memory=8192 \
  --cpus=4 \
  --disk-size=20g \
  --driver=docker

# 필수 애드온 활성화
minikube addons enable ingress
minikube addons enable metrics-server

# Docker 환경을 Minikube와 연결
eval $(minikube docker-env)

# 상태 확인
minikube status
kubectl get nodes
```

## 📦 3단계: RabbitMQ 설치

### 네임스페이스 및 RabbitMQ 설치

```bash
# 네임스페이스 생성
kubectl create namespace bss-queue-system

# Helm으로 RabbitMQ 설치
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update

helm install rabbitmq bitnami/rabbitmq \
  --namespace bss-queue-system \
  --set auth.username=admin \
  --set auth.password=secretpassword \
  --set persistence.enabled=true \
  --set persistence.size=10Gi \
  --wait

# 설치 확인
kubectl get pods -n bss-queue-system
```

## 🐳 4단계: 애플리케이션 이미지 빌드

### Docker 이미지 빌드

```bash
# Minikube Docker 환경 확인
eval $(minikube docker-env)

# Producer 이미지 빌드
docker build -f docker/Dockerfile.producer -t bss-producer:latest .

# Consumer 이미지 빌드 (각 서비스별)
docker build -f docker/Dockerfile.consumer -t subscription-processor:latest \
  --build-arg SERVICE_TYPE=subscription .

docker build -f docker/Dockerfile.consumer -t mnp-processor:latest \
  --build-arg SERVICE_TYPE=mnp .

docker build -f docker/Dockerfile.consumer -t change-processor:latest \
  --build-arg SERVICE_TYPE=change .

docker build -f docker/Dockerfile.consumer -t termination-processor:latest \
  --build-arg SERVICE_TYPE=termination .

# 빌드된 이미지 확인
docker images | grep -E "(bss-producer|processor)"
```

## ⚙️ 5단계: Kubernetes 리소스 배포

### ConfigMap 배포

```bash
# 프로젝트의 Kubernetes 매니페스트 배포
kubectl apply -f k8s/namespace.yaml
kubectl apply -f k8s/configmap/
```

### Producer 배포

```bash
# Producer 및 Service 배포
kubectl apply -f k8s/producer/

# 배포 상태 확인
kubectl get deployment bss-producer -n bss-queue-system
kubectl get pods -l app=bss-producer -n bss-queue-system
```

### Consumer 배포

```bash
# 모든 Consumer 서비스 배포
kubectl apply -f k8s/consumer/

# HPA (자동 스케일링) 확인
kubectl get hpa -n bss-queue-system

# Consumer Pod 상태 확인
kubectl get pods -l app=subscription-processor -n bss-queue-system
kubectl get pods -l app=mnp-processor -n bss-queue-system
```

## 🔧 6단계: 포트 포워딩 설정

### 포트 포워딩 스크립트 실행

```bash
# 프로젝트에 포함된 포트 포워딩 스크립트 실행
chmod +x scripts/setup-port-forwarding.sh
./scripts/setup-port-forwarding.sh

# 또는 수동으로 포트 포워딩
kubectl port-forward svc/rabbitmq 15672:15672 -n bss-queue-system &
kubectl port-forward svc/bss-producer-service 8000:8000 -n bss-queue-system &
```

### 포트 충돌 해결 (필요시)

```bash
# 8000 포트 사용 프로세스 확인
lsof -i :8000

# 8000 포트 사용 프로세스 종료
lsof -ti :8000 | xargs kill

# 포트 포워딩 재시작
kubectl port-forward svc/bss-producer-service 8000:8000 -n bss-queue-system &
```

## ✅ 7단계: 배포 상태 확인

### 전체 시스템 상태 점검

```bash
# 모든 리소스 상태 확인
kubectl get all -n bss-queue-system

# Pod 로그 확인
kubectl logs -l app=bss-producer -n bss-queue-system
kubectl logs -l app=subscription-processor -n bss-queue-system

# 서비스 엔드포인트 확인
kubectl get endpoints -n bss-queue-system
```

### API 연결 테스트

```bash
# Producer API Health Check
curl http://localhost:8000/health

# 모니터링 상태 확인
curl http://localhost:8000/api/monitoring/status

# 기본 메시지 전송 테스트
curl -X POST http://localhost:8000/api/message \
  -H "Content-Type: application/json" \
  -d '{
    "타입": "SUBSCRIPTION",
    "내용": "테스트 메시지",
    "속성들": {"테스트": true}
  }'
```

## 🧪 8단계: 부하 테스트 실행

### 기본 부하 테스트

```bash
# 프로젝트에 포함된 부하 테스트 스크립트 실행
python scripts/basic_load_test.py

# 또는 실험 모듈 사용
python -m src.experiments.load_generator --requests 1000 --concurrency 50
```

### 대용량 부하 테스트

```bash
# 대용량 부하 테스트 실행
python scripts/high_volume_test.py

# 10,000개 요청 테스트
python -m src.experiments.load_generator \
  --requests 10000 \
  --concurrency 200 \
  --test-type burst
```

### 모니터링과 함께 부하 테스트

```bash
# 별도 터미널에서 실시간 모니터링 시작
python scripts/monitor_system.py

# 메인 터미널에서 부하 테스트 실행
python scripts/comprehensive_load_test.py
```

## 📊 9단계: 실시간 모니터링

### Pod 리소스 모니터링

```bash
# 실시간 Pod 상태 모니터링 (macOS 호환)
watch -n 3 "kubectl get pods -n bss-queue-system"

# 또는 Python 모니터링 스크립트 사용
python scripts/pod_monitor.py

# 특정 Pod 집중 모니터링
python scripts/pod_monitor.py producer
python scripts/pod_monitor.py subscription
```

### 시스템 리소스 모니터링

```bash
# CPU/메모리 사용량 실시간 확인
kubectl top pods -n bss-queue-system

# 자동 스케일링 상태 모니터링
kubectl get hpa -n bss-queue-system --watch
```

## 🎯 10단계: 모니터링 스위치 테스트

### 모니터링 ON/OFF 기능 테스트

```bash
# 현재 모니터링 상태 확인
curl http://localhost:8000/api/monitoring/status

# 모니터링 토글 (켜기/끄기)
curl -X POST http://localhost:8000/api/monitoring/toggle

# 모니터링 명시적 제어
curl -X POST http://localhost:8000/api/monitoring/enable   # 켜기
curl -X POST http://localhost:8000/api/monitoring/disable  # 끄기
```

### 모니터링 성능 영향 측정

```bash
# 모니터링 ON/OFF 성능 비교 테스트
python scripts/monitoring_performance_test.py

# 결과 분석
python scripts/analyze_monitoring_impact.py
```

## 🔬 11단계: Queue-Based Load Leveling 패턴 검증

### 패턴 효과 검증 테스트

```bash
# 급증 부하 패턴 테스트 (부하 평활화 효과 확인)
python -m src.experiments.pattern_validator \
  --test-type burst_leveling \
  --burst-size 5000 \
  --duration 120

# 시스템 안정성 테스트
python -m src.experiments.pattern_validator \
  --test-type stability \
  --duration 300 \
  --sustained-load 100

# 자동 스케일링 검증
python -m src.experiments.pattern_validator \
  --test-type auto_scaling \
  --target-cpu 80
```

### 종합 패턴 검증

```bash
# 모든 패턴 효과를 종합적으로 검증
python scripts/comprehensive_pattern_test.py

# 검증 보고서 생성
python scripts/generate_validation_report.py
```

## 📈 12단계: 성능 결과 분석

### 대시보드 접근

```bash
# RabbitMQ 관리 UI 접속
echo "RabbitMQ Management: http://localhost:15672"
echo "Username: admin, Password: secretpassword"

# Kubernetes 대시보드 실행
minikube dashboard

# Producer API 문서 접속
echo "API Docs: http://localhost:8000/docs"
```

### 로그 및 메트릭 분석

```bash
# 실시간 로그 확인
kubectl logs -f -l app=bss-producer -n bss-queue-system
kubectl logs -f -l app=subscription-processor -n bss-queue-system

# 메트릭 수집 결과 확인
python scripts/collect_metrics.py --duration 600  # 10분간 수집

# 성능 분석 리포트 생성
python scripts/performance_analysis.py
```

## 🧹 13단계: 정리 및 클린업

### 시스템 정리

```bash
# 포트 포워딩 종료
pkill -f "kubectl port-forward"

# 배포된 애플리케이션 제거
kubectl delete namespace bss-queue-system

# RabbitMQ 제거
helm uninstall rabbitmq -n bss-queue-system

# Minikube 정지 (선택적)
minikube stop

# Minikube 완전 삭제 (선택적)
minikube delete
```

## 🎯 성공 기준 및 검증 체크리스트

### 배포 성공 기준

- [ ] 모든 Pod가 Running 상태
- [ ] Producer API Health Check 응답 (200 OK)
- [ ] RabbitMQ 관리 UI 접속 가능
- [ ] Consumer Pod들이 메시지 처리 로그 출력
- [ ] HPA가 정상적으로 구성됨

### 부하 테스트 성공 기준

- [ ] 1,000개 요청 처리 성공률 95% 이상
- [ ] 10,000개 요청 처리 완료
- [ ] 평균 응답 시간 2초 이내
- [ ] 시스템 안정성 유지 (Pod 재시작 없음)
- [ ] 자동 스케일링 동작 확인

### 패턴 검증 성공 기준

- [ ] 부하 평활화 효과 확인 (급증 → 안정적 처리)
- [ ] 큐 버퍼링 효과 측정
- [ ] 모니터링 ON/OFF 성능 차이 < 15%
- [ ] Consumer 스케일링 정상 동작
- [ ] 메시지 손실률 1% 미만

## 💡 문제 해결 가이드

### 일반적인 문제들

**Pod가 시작되지 않는 경우:**
```bash
kubectl describe pod <pod-name> -n bss-queue-system
kubectl logs <pod-name> -n bss-queue-system
```

**포트 포워딩 실패:**
```bash
lsof -i :8000
pkill -f "kubectl port-forward"
```

**이미지 Pull 오류:**
```bash
eval $(minikube docker-env)
docker images | grep bss
```

**RabbitMQ 연결 실패:**
```bash
kubectl get services -n bss-queue-system
kubectl port-forward svc/rabbitmq 15672:15672 -n bss-queue-system
```

## 📞 추가 리소스

- **프로젝트 GitHub**: https://github.com/xotlr333/queue-based-load-leveling
- **Minikube 문서**: https://minikube.sigs.k8s.io/docs/
- **RabbitMQ 문서**: https://www.rabbitmq.com/documentation.html
- **Kubernetes 문서**: https://kubernetes.io/docs/

---

**이 가이드를 통해 GitHub 프로젝트를 성공적으로 배포하고 Queue-Based Load Leveling 패턴의 효과를 실증할 수 있습니다.**